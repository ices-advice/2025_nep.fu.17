---
title: "output_02_catch_options"
author: "Haleigh Joyce"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r libs, message=FALSE, echo=TRUE, warning=FALSE}
gc()
rm(list=ls())

library(RODBC)
library(tidyverse)
library(lattice)
library(lubridate)
library(mapplots)
library(sp)
library(sf)
library(reshape2)
library(readxl)
library(knitr)
library(DataCombine)
library(lattice)
library(icesTAF)
library(magrittr)
library(viridis)
library(sessioninfo)
library(stringr)
```


## Setup options

```{r setupoptions}
curr.year <- 2025
dat.year <- curr.year -1
fu.n <- "FU17"

save.plots <- T # set it up as T or F whether you want to save the plots when running all the chunks or kniting the document
save.tables <- T # set it up as T or F whether you want to save the tables "propmature"" and the "L50" into .txt files when running all the chunks or knitting the document
```

## Introduction

The goals of this R Markdown document are to:

* Calculate catch scenarios for the stock
* Write TAF data tables

Files before (inside "output_01_assessment_summary"):

* fu17.exp.wg.csv

Files before (inside "boot/data"):

* MSY_nep_stocks.csv


Files after (inside "output_02_catch_options"):

* fu17.catch.inputs.ADG.csv
* fu17.recent_discards.ADG.csv
* fu17.assess.ADG.csv

## Data Work Up
<a href="#top">Back to top</a>

This markdown documment calculates the catch scenarios for this stock.
First set up the basis for the forecast tables such as mean weights, discard rates etc.
Then load the MSY ranges checking that the UWTV survey estimate in relation to Btrigger reference point.
Calculate the forecast tables for catches assuming recent discard patterns and also catches assuming zero discards.

## Load the data file. 
<a href="#top">Back to top</a>

This file will have the most recent UWTV survey data and the fishery summary of the previous year.
This table is outputted in format for Table 5 advice sheet.

```{r data, echo=TRUE, message=FALSE}

fu17.exp <- read.csv("output/output_01_assessment_summary/fu17.exp.wg.csv")

fu17.assess <- fu17.exp[,c("year", "abund", "upper", "lower", "conf.int", "int.lan.num", "int.dis.num", "removals.n", "harvest.ratio","int.lan.wgt", "int.dis.wgt", "dis.rn", "dead.disc.r", "mw.lan", "mw.dis")]


 if (save.tables == T) {
   write.table(fu17.assess, "output/output_02_catch_options/fu17.assess.ADG.csv", sep=",",  row.names = F)
   }

```

## The basis for the catch advice and scenarios. 
<a href="#top">Back to top</a>


```{r Inputs to Catch option table, message=FALSE, warning=FALSE}

## make sure this is correct
wgneph.yr <- dat.year + 1


# full range for Aran - for the mean estimations
land.wt.yrs <- seq(2008,wgneph.yr-1,1)
disc.wt.yrs <- seq(2008,wgneph.yr-1,1)


discard.rate.yrs <- seq(wgneph.yr-3,wgneph.yr-1,1)
dead.discard.rate.yrs <- seq(wgneph.yr-3,wgneph.yr-1,1)
prop.removal.ret.yrs <- seq(wgneph.yr-3,wgneph.yr-1,1)


stock.abundance <- fu17.exp$abund[length(fu17.exp$abund)]


land.mean.wt <- mean(fu17.exp$mw.lan[fu17.exp$year %in% land.wt.yrs],na.rm=T)
disc.mean.wt <- mean(fu17.exp$mw.dis[fu17.exp$year %in% land.wt.yrs],na.rm=T)

discard.rate <- mean(fu17.exp$dis.rn[fu17.exp$year%in% discard.rate.yrs],na.rm=T)

dead.discard.rate <- mean(fu17.exp$dead.disc.r[fu17.exp$year %in% dead.discard.rate.yrs],na.rm=T)
prop.removal.ret.n <- mean(fu17.exp$prop.removals.ret[fu17.exp$year %in% prop.removal.ret.yrs], na.rm=T)
disc.survival <- 25/100


fu17.catch.inputs<- data.frame(wgneph.yr, stock.abundance, land.mean.wt, disc.mean.wt,discard.rate,dead.discard.rate,disc.survival)

knitr::kable(fu17.catch.inputs , digits=5)

if (save.tables == T) {
write.csv(fu17.catch.inputs, "output/output_02_catch_options/fu17.catch.inputs.ADG.csv", sep=",", row.names = F) # Table 1 in advice sheet
}
```

## MSY ranges inputs for the forecast tables.
<a href="#top">Back to top</a>

Calculate MSY approach: when TV abundance < Btrigger = FmsyHR*TVabundance/Btrigger
Take Harvest Rate reference points points from Stock Annex.
Calculate F_recent (select recent 3 yrs).

```{r F current calculation, echo=TRUE, message=FALSE, warning=FALSE}

ref <- read.csv("boot/data/intercatch/MSY.nep.stocks.csv")

ref17 <- ref[ref$Stock.code=="nep-17", c("F_MSY", "MSY_F_lower", "MSY_F_upper", "MSY_Btrigger", "F_35_SPR", "F_Max")]


MSY_Btrigger <- as.numeric(as.character(ref17$MSY_Btrigger))
ref17$F_35_SPR <- as.numeric(as.character(ref17$F_35_SPR))
ref17$F_Max <- as.numeric(as.character(ref17$F_Max))


HR17 <- cbind("MSY approach"= ref17$F_MSY*stock.abundance/MSY_Btrigger,
              "Flower_Trig"= ref17$MSY_F_lower*stock.abundance/MSY_Btrigger,
              "F_MSY" = ref17$F_MSY,
              "MSY_F_lower" = ref17$MSY_F_lower,
              "MSY_F_upper" = ref17$MSY_F_upper,
              # "F_recent"= mean (fu17.exp[fu17.exp$year %in% (wgneph.yr-3):(wgneph.yr-1),] $ harvest.ratio /100),
              "F_current"= fu17.exp[fu17.exp$year==(wgneph.yr-1),] $ harvest.ratio /100)

#row.names(HR17) <- NULL

knitr::kable(HR17)
```

## Table 3: Catch scenarios assuming zero discards.
<a href="#top">Back to top</a>

Annual catch scenarios. All weights are in tonnes.

```{r table LO, echo=TRUE, message=FALSE, warning=FALSE}
forecast.year <- wgneph.yr+1

wanted.catch <-  ((1-discard.rate)*(land.mean.wt)*stock.abundance*(HR17))
unwanted.catch <- ((discard.rate)*(disc.mean.wt)*stock.abundance*(HR17))
total.catch <- as.data.frame(wanted.catch + unwanted.catch)

adv24 <- as.data.frame(cbind("MSY approach" = 649,
               "Flower_Trig" = 565,
               "F_MSY" = 649,
               "MSY_F_lower" = 649,
               "MSY_F_upper" = 649,
               "F_current" = 649))


#adv24 <- as.data.frame(cbind("MSY approach" = 649,
              # "Flower_Trig" = 565,
              # "F_MSY" = 777,
              # "MSY_F_lower" = 676,
              # "MSY_F_upper" = 777,
              # "F_current" = 650))

advice.both <- rbind(total.catch, adv24)
# advice.change <- (round(total.catch)/adv20-1)*100
advice.change <- (round(advice.both[1,])/advice.both[2,]-1)*100

LO <- rbind(total.catch, wanted.catch, unwanted.catch, HR17*100, advice.change, forecast.year) #LO=landings obligation
LO <- as.data.frame(cbind(t(LO), t(adv24)))
names(LO) <- c("total.catch", "wanted.catch", "unwanted.catch", "HR17", "advice.change", "forecast.year", "corresponding.last.year.values.for.advicesheet")

for (i in 1:(ncol(LO)-4)){
  LO[,i] <- as.character(LO[,i])
  LO[,i] <- as.numeric(LO[,i])
  LO[,i] <- round(LO[,i])
}

knitr::kable(LO)

#write.csv(LO, "FU17.LO.forecast.ADG.2024.csv")

## write.csv(LO, "output/output_02_catch_options/fu17.zero_discards.ADG.csv")
```

## Table 3: Catch scenarios assuming recent discards.
<a href="#top">Back to top</a>

Annual catch scenarios. All weights are in tonnes.

Check stock abundance below Btrigger as this requires extra catch options.

```{r table DA, echo=TRUE, message=FALSE, warning=FALSE}

landings <-  (land.mean.wt)*stock.abundance*prop.removal.ret.n*(HR17)

dead.discards <- (disc.mean.wt)*stock.abundance*(1-prop.removal.ret.n)*(HR17)
surviving.discards <- dead.discards/3
dead.removals <- landings + dead.discards
total.catch <- landings+dead.discards+surviving.discards

advice.both <- rbind(total.catch, adv24)
# advice.change <- (round(total.catch)/adv20-1)*100
advice.change <- (round(advice.both[1,])/advice.both[2,]-1)*100

DA <- rbind(total.catch, dead.removals, landings, dead.discards, surviving.discards, HR17*100, advice.change, forecast.year)
DA <- as.data.frame(cbind(t(DA), t(adv24)))
names(DA) <- c("total.catch", "dead.removals", "projected.landings", "projected.dead.discards", "projected.surviving.discards", "harvest.rate", "advice.change", "forecast.year", "corresponing.last.year.values.for.advicesheet")

for (i in 1:(ncol(DA)-4)){
  DA[,i] <- as.character(DA[,i])
  DA[,i] <- as.numeric(DA[,i])
  DA[,i] <- round(DA[,i])
}

knitr::kable(DA[,c(1:3,8)])
knitr::kable(DA[,c(4:8)])


if (save.tables == T) {
write.csv(DA, "output/output_02_catch_options/fu17.recent.discards.ADG.csv")
}
```
<a href="#top">Back to top</a>



