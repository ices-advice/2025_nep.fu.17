---
title: "output_01_assessment_summary"
author: "Haleigh Joyce"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r libs, message=FALSE, echo=TRUE, warning=FALSE}
gc()
rm(list=ls())

library(RODBC)
library(tidyverse)
library(lattice)
library(lubridate)
library(mapplots)
library(sp)
library(sf)
library(reshape2)
library(readxl)
library(knitr)
library(DataCombine)
library(lattice)
library(icesTAF)
library(magrittr)
library(viridis)
library(sessioninfo)
library(stringr)
```

# Setup options

```{r setupoptions}
curr.year <- 2025
dat.year <- curr.year -1
fu.n <- "FU17"

save.plots <- T # set it up as T or F whether you want to save the plots when running all the chunks or kniting the document
save.tables <- T # set it up as T or F whether you want to save the tables "propmature"" and the "L50" into .txt files when running all the chunks or knitting the document
```

# Introduction

The goals of this R Markdown document are to:

* Create Assessment summary Table and calculate Harvest Rate in the fishery year..
* Write TAF data tables

Files before (inside "model_01_raising_to_international"):

* fu17_fishery_summary.csv #made in Model 01 script


Files before (inside "model_03_UWTV_RandomStratified_Method"):

* fu17.total.abund.estimates.csv

Files after (inside "output_01_assessment_summary"):

* fu17.exp.wg2025.csv
* fu17.nep.stock.wgmixfish.csv
* fu17_Harvest_Rate.png
* fu17_Harvest_Rate.png
* fu17_Harvest_Rate.png



## Load data files 
<a href="#top">Back to top</a>

This UWTV data summary file is calculated in model_03_UWTV_RandomStratified_Method folder when new survey data is finalised and all grounds combined to calculate abundance.
Abundance estimate is used to calculate harvest rate (removals.n/abundance) in the fishery.
Commercial fishery sampling programme began in 2002.
UWTV surveys series started in 2002. 
summ.hist is from previous WG and has been checked against advice sheet
```{r uwtv table}

summ <-read.csv("model/model_01_raising_to_international/fu17.fishery.summary.csv")
summ<- rbind(summ, c(max(summ$year)+1, rep(NA, ncol(summ)-1)))

summ.hist<-read.csv("boot/data/intercatch/fu17.hist.csv")


summ.hist$prop.removals.ret<-summ.hist$int.lan.num/summ.hist$removals.n
summ.hist$dead.disc.wgt <- summ.hist$int.dis.wgt * 0.75

summ.hist<-summ.hist[ ,-14]

summ <- rbind(summ.hist,summ)


tv <- read.csv("model/model_03_UWTV_RandomStratified_Method/FU17.total.abund.estimates.csv")

names(tv) <- c("year", "abund",   "upper", "lower")


exp <- merge(summ, tv[,c("year", "upper", "abund", "lower")], by = "year")

# Interpolate 2021 and 2023 abundance values for 2022 (no survey)
exp$abund[exp$year == 2022] <- mean(exp$abund[exp$year %in% c(2021, 2023)]) 

exp$ci <- with(exp, abs(abund-upper))
exp$harvest.rate <- with(exp, removals.n/abund)*100

exp$ogive <- 'annual'

#put in same format for report/adg same as FU7- North Sea stocks
fu17.exp <- exp[c("year", "int.lan.num", "int.dis.num", "int.lan.wgt", "int.dis.wgt", "removals.n", "prop.removals.ret", "dead.disc.r", "dis.rn", "dis.rw", "mw.lan", "mw.dis", "abund", "ci", "upper", "lower", "harvest.rate" )]

knitr::kable(fu17.exp[ ,c(1:7)] , digits=3)
knitr::kable(fu17.exp[ ,c(1, 8:17)] , digits=3)

 if (save.tables == T) {
write.table(fu17.exp, "output/output_01_assessment_summary/fu17.exp.wg.csv",  sep=",", row.names = F)
 }
```


## Reformat for WGMIXFISH Stock object
<a href="#top">Back to top</a>

```{r mixfish table}

mix <- exp[c("year","abund", "ci", "int.lan.num", "int.dis.num", "removals.n", "harvest.rate", "int.lan.wgt", "int.dis.wgt","dis.rn","dead.disc.r",
             "mw.lan", "mw.dis","dis.rw","prop.removals.ret")]

mix$survival.rate <- "0.25"
mix$survival.rate <- as.numeric(mix$survival.rate)

mix <- mix %>%
  add_column(fu = "fu.17",
             .before = "year")

names(mix) <- c("fu", "year", "abund", "ci", "landings.n", "discards.n", "removals.numbers", "harvest.rate", "landings.t", "discards.t", 
                "discard.rate.n", "dead.disc.rate.n", "mean.wt.lan.gr", "mean.wt.dis.gr", "discard.rate.wgt", "prop.removal.ret.n", "survival.rate")

 if (save.tables == T) {
write.table(mix, "output/output_01_assessment_summary/fu17.nep.stock.wgmixfish.csv",  sep=",", row.names = F)
 }

tail(mix)

```


## Plot TV abundance and Confidance Intervals and MSY Btrigger.
<a href="#top">Back to top</a>

Btrigger was established for this stock as FMSYRef4 meeting.
Check CIs as was a legacy issue last year and were checked for ADG 2018.
MSY Btrigger estimated at WKFMSYREF4 (ICES, 2016) = 990 million.
Btrigger re-estimated at 1140 million by WGCSE 2021 - due to update in abundance estimates.

```{r abund, echo=FALSE, warning=FALSE, fig.cap="FU17 UWTV abundance estimates (millions of individuals) and Btrigger displayed as dashed line."}

# Extract the value 'MSY_Btrigger' from MSY.nep.stocks.csv
msy_nep <- read_csv("boot/data/intercatch/MSY.nep.stocks.csv", show_col_types = FALSE)
MSY_Btrigger <- msy_nep %>%
  mutate(MSY_Btrigger = as.numeric(MSY_Btrigger)) %>%
  filter(`Stock code` == "nep-17") %>%  # Ensure the column name is correct
  pull(`MSY_Btrigger`) %>% 
  as.numeric()  # Convert to numeric if necessary

 
    ggplot(fu17.exp, aes(x=year, y= abund)) +
          theme_bw() +
          geom_errorbar(aes(ymax=upper, ymin=lower, width=0.25)) +
          geom_line(size = 1) +
          geom_point() +
          theme(panel.grid = element_blank()) +
            scale_x_continuous(name="\nYear",
                             breaks = seq(min(fu17.exp$year,na.rm = TRUE), max(fu17.exp$year,na.rm = TRUE), 2)) +
          scale_y_continuous(name = "Abundance (millions)\n",
                             breaks = seq(0, max(fu17.exp$upper,na.rm = TRUE)+400, 250),
                             limits = c(0, max(fu17.exp$lower,na.rm = TRUE)+400)) + 
          geom_hline(aes(yintercept=MSY_Btrigger),colour="#990000",linetype="dashed",size = 0.9) #Check MSY_Btrigger is set to this stock

if (save.plots == T) {
ggsave("output/output_01_assessment_summary/fu17_UWTV_Survey.png")
}
    
```


## Plot of estimated mean weights from National sampling programme.
<a href="#top">Back to top</a>

Plot mean weights (grs) in landings and discards.

```{r mw, echo=FALSE, warning=FALSE, fig.cap="fu17 Mean weights in grs series.Mean weight landings (blue line) and mean weight discards (red line)."}

mw<-fu17.exp [ , c("year", "mw.lan" ,"mw.dis")]
mw <- mw %>% gather("mw.lan", "var",2:3)
names(mw) <- c("year", "type", "wgt")

p3 <- ggplot(mw, aes(x=year, y=wgt, group=type, colour=factor(type))) + 
        geom_line(size=.75)  +  theme_bw() +
        xlab("\nYear") +
        scale_x_continuous(name="\nYear",
                             breaks = seq(min(mw$year,na.rm = TRUE), max(mw$year,na.rm = TRUE), 2)) + scale_y_continuous(name = "Mean weight (gr)\n",
                          limits = c(0, 30),
                          breaks = seq(0, 30, 5)) +
        scale_colour_manual(labels=c("Discards mean weight", "Landings mean weight"), values=c("black","blue")) +
        theme(panel.grid=element_blank(), legend.position = "bottom") 
 
p3 + theme(axis.text=element_text(size=10),axis.title=element_text(size=10)) + theme(legend.title=element_blank()) 

if (save.plots == T) {
ggsave("output/output_01_assessment_summary/fu17_Mean_weights.png")
}

```


## Plot of Harvest Rates Updated Survey series
<a href="#top">Back to top</a>

Current MSY Harvest Rate of 8.5% for fu17 by WKMSYRef4 (ICES, 2016)
Harvest rates are very high in early years (2007-2008) where this can be explained by recruitment into the fishery. This signal was picked up by the beam trawl during the 2006 UWTV survey and also the IBTS -Irish and French Survey Nephrops Length Frequency Distributions.
Refer to WGCSE fu17 report section and recent Marine Institute UWTV report fu17. 

```{r hr, echo=FALSE, warning=FALSE,fig.height=8, fig.width=8, fig.cap="fu17 Harvest Rate series."}


F_MSY<- msy_nep %>%
  mutate(F_MSY = as.numeric(F_MSY)) %>%
  filter(`Stock code` == "nep-17") %>%  # Ensure the column name is correct
  pull(`F_MSY`) %>% 
  as.numeric() * 100  # Convert to numeric if necessary and to a percentage

p4 <- ggplot(fu17.exp, aes(year, harvest.rate)) + 
  geom_line(size = 1) +
    theme_bw() + #remove grids
  scale_x_continuous(name="\nYear",
                             breaks = seq(min(fu17.exp$year,na.rm = TRUE), max(fu17.exp$year,na.rm = TRUE), 2)) +
  coord_cartesian(ylim= c(0, 30), xlim=c(2002,dat.year)) + 
    ylab("Harvest rate percent")


p4 + geom_hline(aes(yintercept=F_MSY),size = 1,colour="blue", linetype="dashed") + 
 theme(axis.text=element_text(size=10),axis.title=element_text(size=10))

if (save.plots == T) {
ggsave("output/output_01_assessment_summary/fu17_Harvest_Rate.png")
}
```


<a href="#top">Back to top</a>

## Session
<a href="#top">Back to top</a>
```{r info , echo=TRUE, warning=FALSE, fig.height=8, fig.width=8}
session_info()

```
